name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "claude/*" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  validate-workflows:
    name: Validate n8n Workflows
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate JSON syntax
        run: |
          echo "ðŸ” Validating n8n workflow JSON files..."
          find . -name "*.json" -type f ! -path "./node_modules/*" ! -path "./.git/*" | while read file; do
            echo "Checking: $file"
            if ! jq empty "$file" 2>/dev/null; then
              echo "âŒ Invalid JSON: $file"
              exit 1
            fi
          done
          echo "âœ… All JSON files are valid"

      - name: Check for credentials in workflows
        run: |
          echo "ðŸ”’ Checking for exposed credentials..."
          if grep -r -i -E "(password|api_key|secret|token).*[:=].*[\"'][^\"']{10,}" --include="*.json" .; then
            echo "âš ï¸ WARNING: Possible credentials found in workflow files!"
            echo "Please use n8n's credential system instead of hardcoded values."
            exit 1
          fi
          echo "âœ… No exposed credentials detected"

  lint-documentation:
    name: Lint Markdown Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint
        run: npm install -g markdownlint-cli

      - name: Lint markdown files
        run: |
          echo "ðŸ“ Linting markdown documentation..."
          markdownlint '**/*.md' --ignore node_modules --ignore .git || true
          echo "âœ… Markdown linting complete"

  validate-docker-compose:
    name: Validate Docker Compose Configs
    runs-on: ubuntu-latest
    strategy:
      matrix:
        config:
          - docker-compose/withPostgres
          - docker-compose/withPostgresAndWorker
          - docker-compose/subfolderWithSSL
          - docker-caddy
    steps:
      - uses: actions/checkout@v4

      - name: Validate docker-compose.yml
        run: |
          echo "ðŸ³ Validating ${{ matrix.config }}/docker-compose.yml..."
          cd ${{ matrix.config }}
          docker-compose config > /dev/null
          echo "âœ… Docker Compose config is valid"

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified
        continue-on-error: true

      - name: Check for .env files
        run: |
          echo "ðŸ” Checking for committed .env files..."
          if find . -name ".env" -not -path "./node_modules/*" | grep -q .; then
            echo "âŒ ERROR: .env files found in repository!"
            echo "These should not be committed. Use .env.example instead."
            find . -name ".env" -not -path "./node_modules/*"
            exit 1
          fi
          echo "âœ… No .env files committed"

      - name: Verify .gitignore exists
        run: |
          echo "ðŸ“‹ Verifying .gitignore..."
          if [ ! -f .gitignore ]; then
            echo "âŒ ERROR: .gitignore file missing!"
            exit 1
          fi
          echo "âœ… .gitignore exists"

  validate-python:
    name: Validate Python Scripts
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.modified, '.py') || contains(github.event.head_commit.added, '.py')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black

      - name: Lint with flake8
        run: |
          echo "ðŸ Linting Python files..."
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
          echo "âœ… Python linting complete"

      - name: Check formatting with black
        run: |
          echo "ðŸŽ¨ Checking Python formatting..."
          black --check . || true

  validate-javascript:
    name: Validate JavaScript Code
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.modified, '.js') || contains(github.event.head_commit.added, '.js')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install ESLint
        run: npm install -g eslint

      - name: Lint JavaScript files
        run: |
          echo "ðŸ“œ Linting JavaScript files..."
          eslint **/*.js --no-eslintrc --env es6 --env node || true
          echo "âœ… JavaScript linting complete"

  cost-estimation:
    name: Estimate Workflow Costs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Analyze workflow complexity
        run: |
          echo "ðŸ’° Analyzing workflow costs..."
          echo ""
          echo "| Workflow | Estimated Cost | Model |"
          echo "|----------|----------------|-------|"

          for workflow in workflows/*.json improved_ai_operating_model_workflow.json workflow_*.json; do
            if [ -f "$workflow" ]; then
              # Count OpenAI/GPT nodes
              gpt_nodes=$(jq '[.nodes[] | select(.type == "n8n-nodes-base.openAi" or .type == "n8n-nodes-langchain.lmChatOpenAi")] | length' "$workflow" 2>/dev/null || echo 0)

              # Estimate cost based on node count
              if [ "$gpt_nodes" -gt 10 ]; then
                cost="\$0.99 (Premium)"
                model="GPT-4"
              elif [ "$gpt_nodes" -gt 5 ]; then
                cost="\$0.21 (Standard)"
                model="GPT-4o-mini"
              else
                cost="\$0.01 (Basic)"
                model="GPT-4o-mini"
              fi

              echo "| $(basename $workflow) | $cost | $model |"
            fi
          done
          echo ""
          echo "ðŸ“Š Cost analysis complete. Review COST_ANALYSIS.md for detailed breakdown."

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [validate-workflows, lint-documentation, validate-docker-compose, security-scan]
    if: always()
    steps:
      - name: Check job statuses
        run: |
          echo "## ðŸ“Š CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validate Workflows | ${{ needs.validate-workflows.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint Documentation | ${{ needs.lint-documentation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate Docker Compose | ${{ needs.validate-docker-compose.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.validate-workflows.result }}" == "success" ] && \
             [ "${{ needs.lint-documentation.result }}" == "success" ] && \
             [ "${{ needs.validate-docker-compose.result }}" == "success" ] && \
             [ "${{ needs.security-scan.result }}" == "success" ]; then
            echo "âœ… **All checks passed!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Some checks failed. Please review the logs above.**" >> $GITHUB_STEP_SUMMARY
          fi
